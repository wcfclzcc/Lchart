<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>设备详情</title>


</head>
<body style="background-color:#f8f8f9">

    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="mqtt.js"></script>


<br><br>

<br><br><br><br><br><br><br><br>
<br>


 <div id ="show1" style="margin-left:16px" @mousedown="click_down" @mouseup="click_up">
             <canvas  id="myCanvas" width="1200" height="500" style="border:1px solid #d3d3d3; background-color: rgba(230, 230, 230,0.1);">
        您的浏览器不支持 HTML5 canvas 标签。</canvas>
            </div>

</div>
<br>


</div>





<div class="box" id="box"style="position: absolute;left: 0px;top: 0px;display: none;" >
     <canvas id="myCanvas1" width="150" height="100" style="background-color: rgba(47, 183, 245, 0.2);"></canvas>
</div>

<div id="accept"></div>
<p id="accept1"></p>


</body>

<script>



//建立mqtt连接
        var hostname = '192.168.0.105', //'192.168.1.2',mqtt接口地址
            port = 8083,
            clientId = 'clit-'+Math.floor(Math.random()*10),//客户端id
            timeout = 5,//重连时间
            keepAlive = 100,//每一百秒连接一次
            cleanSession = false,
            ssl = false,
            topic = '/pwm';//主题
        client = new Paho.MQTT.Client(hostname,port, clientId);//建立客户端实例

        var options = {//准备传入connect的参数
            invocationContext: {
                host: hostname,//接口地址
                port: port,//端口
                path: client.path,
                clientId: clientId//客户端名称
            },
            timeout: timeout,
            keepAliveInterval: keepAlive,
            cleanSession: cleanSession,
            useSSL: ssl,
            // userName: userName,
            // password: password,
            onSuccess: onConnect,//连接成功函数
            onFailure: function (e) {//连接失败函数
                console.log("connect failure");
            }
        };
        client.connect(options);
        //连接服务器并注册连接成功处理事件
        function onConnect() {
            console.log("onConnected");//控制台输出
            //alert(topic)
            client.subscribe('/pwm');//订阅主题
            client.subscribe('/pwm/p');//订阅主题
            client.subscribe('/pwm/dc');//订阅主题

        }

        client.onConnectionLost = onConnectionLost;

        //注册连接断开处理事件
        client.onMessageArrived = onMessageArrived;

        //注册消息接收处理事件
        function onConnectionLost(responseObject) {
            console.log(responseObject);
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);
                console.log("连接已断开");
            }
        }

        function onMessageArrived(message) {
            //console.log(message.destinationName);
            //console.log(message.payloadString);
            if(message.destinationName=="/pwm")
            {
                var obj = JSON.parse(message.payloadString);
                //console.log(typeof obj);
                display_data.data1.length=0;

                for(let i in obj)
                {
                    display_data.data1.push(obj[i]);
                }
            }
            else if(message.destinationName=="/pwm/p")
            {
                display_data.data2.push(Number(message.payloadString)/10);
            }
            else if(message.destinationName=="/pwm/dc")
            {
                display_data.data3.push(Number(message.payloadString)/10);
            }
            
            //console.log(typeof display_data.data1[1])
            //display_data.data1.push(obj);



                // if (date_time_mode.acctime_mode == 0)//当前模式为实时接收
                // {
                //     var obj = JSON.parse(message.payloadString);
                //     //console.log(obj);

                //     display_data.data1.push(obj.data1);
                //     display_data.data2.push(obj.data2);
                //     display_data.data3.push(obj.data3);
                //     display_data.data4.push(obj.data4);
                //     //display_data.time.push(new Date().Format("yyyy-MM-dd hh:mm:ss"));

                //     //console.log(display_data);

                //         data_time.push(new Date().Format("yyyy-MM-dd hh:mm:ss"));
                //         data_time_absolute = data_time_absolute.concat(new Date().Format("yyyy-MM-dd hh:mm:ss"));

                //         //console.log(display_data_change);

                // }

            //console.log("消息受到");
            //console.log(tpv);
        }

</script>

<script>




        function detail_text(index)
        {
             var box = document.getElementById('box');
             box.style.display = "block";
            var c=document.getElementById("myCanvas1");//获得canvas
            var ctx1=c.getContext("2d");
             var wid=c.getAttribute("width");
             var hei=c.getAttribute("height");
             c.setAttribute("height","150");
             ctx1.clearRect(0, 0, wid, hei); //清空所有的内容


            ctx1.fillStyle="#555";

             ctx1.font = "bold 15px Arial";
             var he=15;
             for(let key in display_data_change)
             {
                 //ctx1.fillText(key+"："+display_data_change[key][index].toFixed(2),5,he);
                 he+=30;
             }


            //ctx1.fillText(data_time_change[index],5,he);//画出时间信息

             box.style.left = parseInt(mouse_x)+50 + "px";
             box.style.top =parseInt(mouse_y)+290 + "px";


        }




        function data_off(data)//数据舍去
        {
                if(data.length>width)
                {
                    var da = new Array();
                    for(var i=0;i<width;i++)
                    {
                        da[i]=data[parseInt(i*(data.length-1)/width-1)];
                    }
                    return da;
                }
                else{
                    return data;
                }

        }






        function x_transform(len,pos) {//index转换为pos

            return Math.round(pos*width/(len-1));
        }
        function x_transform_back(len,pos) {//pos转换为index

            return Math.round(pos*(len-1)/width);
        }

        function draw_data_all(ctx,data,c1,t1) {


            for(var i=1;i<data.length;i++)
            {
                drawLine(ctx,x_transform(data.length,i-1),data_handel(data[i-1]),x_transform(data.length,i),data_handel(data[i]),c1,t1);
            }
            //document.getElementById("accept1").innerHTML="";


                if(data.length<width/15)//绘画点
                {
                    for(var i=0;i<data.length;i++)
                    {
                        drawc(ctx,x_transform(data.length,i),data_handel(data[i]),"#fff",4);
                        drawc(ctx,x_transform(data.length,i),data_handel(data[i]),"#2db7f5",3);
                    }

                }

        }






   function drawreact(ctx,x1,y1,x2,y2,color,thick)//画矩形
        {
            drawLine(ctx,x1,y1,x2,y1,color,thick);
            drawLine(ctx,x2,y1,x2,y2,color,thick);
            drawLine(ctx,x2,y2,x1,y2,color,thick);
            drawLine(ctx,x1,y2,x1,y1,color,thick);
        }

        function drawLine(ctx,x1,x2,x3,x4,color,thick)//画普通的线
        {
            ctx.save();
            ctx.beginPath();
            ctx.strokeStyle=color;
            ctx.lineWidth=thick;
            ctx.moveTo(x1,x2);
            ctx.lineTo(x3,x4);
            ctx.stroke();
            ctx.restore();
        }
        function drawuLine(ctx,x1,x2,x3,x4)//画粗线
        {
            ctx.save();
            ctx.beginPath();
            ctx.strokeStyle="green";
            ctx.setLineDash([20, 5]);  // [实线长度, 间隙长度]
            ctx.lineDashOffset = -0;
            ctx.moveTo(x1,x2);
            ctx.lineTo(x3,x4);
            ctx.stroke();
            ctx.restore();
        }
        function drawpoint(ctx,x,y)
        {
            ctx.beginPath();
            ctx.strokeStyle="black";
        //  ctx.lineWidth=2;
            ctx.moveTo(x,y-1);
            ctx.lineTo(x,y+1);
            ctx.stroke();
        }

        function drawc(ctx,x,y,color,round) {//画圆点

            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, round, 0, 2* Math.PI);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.restore();

        }

</script>



<script>


         function position_detect(ctx)//鼠标位置检测，看应该显示那一组数据
        {
            var index=x_transform_back(display_data_change.data1.length,mouse_x);//获得鼠标最近的数据的index
            var pos=x_transform(display_data_change.data1.length,index);

            drawLine(ctx,pos,0,pos,height,"#5cadff",2);
            detail_text(index);

            for(let key  in display_data_change){
                 //console.log(display_data[key])
                //console.log(display_data_change[key]);
                    drawc(ctx,pos,data_handel(display_data_change[key][index]),"#fff",4);
                    drawc(ctx,pos,data_handel(display_data_change[key][index]),"#2db7f5",3);
              }
        }


        function scroll_x(wheel) {



            var len=display_data_change.data1.length;


                var pos=x_transform_back(len,mouse_x);//鼠标所指的数据位置
                var cut=0;//表示缩放幅度
                if(len>10)
                {
                    cut=parseInt(len/10);
                }
                else{
                    cut=10;
                }

                    if (wheel < 0) {//向下滚动,缩小

                        console.log('向下滚动');

                        if (zoom > 0) {
                            change_left-=Math.round(cut*pos/len);
                            change_right+=Math.round(cut*(len-pos)/len);
                            zoom-=1;
                            console.log('向下滚动');
                        }
                        else if(select_range.switch)
                        {
                            if(change_left-Math.round(cut*pos/len)>0)
                            {
                                change_left-=Math.round(cut*pos/len);
                            }
                            if(change_right+Math.round(cut*(len-pos)/len)<hpv.length)
                            {
                                change_right+=Math.round(cut*(len-pos)/len);
                            }

                        }


                    } else {//向上滚动，放大


                        if (len >10 ) {
                            zoom += 1;
                            change_left+=Math.round(cut*pos/len);
                            change_right-=Math.round(cut*(len-pos)/len);
                            console.log('向上滚动');
                        }

                    }

                console.log(len);
            console.log(change_left+",,,,"+change_right);
                if(change_right>display_data.data1-1)
                    {
                        change_right=display_data.data1;
                    }
                    if(change_left<1)
                    {
                        change_left=0;
                    }

                    for(let key in display_data_change)
                    {
                        display_data_change[key]=zoom_data(display_data[key],change_left,change_right)
                    }


                    //data_time_change=zoom_data(data_time,change_left,change_right);
        }


        function scroll_y(wheel) {

            if(wheel>0)
            {
                k+=2;
            }
            else{
                k-=2;
            }
            if(k<3)
            {
                k=3;
            }
            if(k>30)
            {
                k=30;
            }

        }

        function onMouseScroll(e) {

            if (e.preventDefault) {
                    e.preventDefault();
            }
            var wheel = e.originalEvent.wheelDelta;
            if (isin == 1) {

                if(select_range.is_x)
                {
                    scroll_y(wheel);
                }
                else{
                    scroll_x(wheel);
                }
                }


        }

</script>


<script>

    





    


        var device_id;
        var device_name;

        device_id='{{ device_id }}'; //JSON.parse('{{ device_id }}');
        device_name='{{ device_name }}'; //JSON.parse('{{ device_name }}');
        console.log('device_id='+device_id);
        var index=0;
        var isaccept=0;
        var isin=0;
        var tpv=new Array();//新建一个温度数组
        var hpv=new Array();//新建一个湿度数组
        var data_time=new Array();//保存时间数据
/*
        var display_data=new Object;//新建一个显示数据的对象;
    display_data.data1=new Array();
    display_data.data2=new Array();
    display_data.data3=new Array();
    display_data.data4=new Array();
    */


    var display_data=new Object;

    display_data.data1=new Array();
    display_data.data2=new Array();
    display_data.data3=new Array();
    display_data.data4=new Array();


    display_data.data1.push(1);
    display_data.data2.push(1);
    display_data.data3.push(1);
    display_data.data4.push(1);

    for(let key in display_data)
    {
        for (let i=0;i<display_data[key].length;i++)
         display_data[key][i]=Number(display_data[key][i]);

    }


    var display_data_change=new Object;//新建一个显示数据的对象;
    display_data_change.data1=new Array();
    display_data_change.data2=new Array();
    display_data_change.data3=new Array();
    display_data_change.data4=new Array();


        var tpv_change=new Array();//新建一个改变后的温度数组
        var hpv_change=new Array();//新建一个改变后的湿度数组
        var data_time_change=new Array();
        var change_left=0;
        var change_right=0;


        var data_time_relative=new Array();
        var data_time_absolute=new Array();


        var mouse_x=0;
        var mouse_y=0;
        var click_isdown=false;//鼠标是否按下
        var click_pos=new Object();
        click_pos.x=0;
        click_pos.y=0;
        var mouse_x_stop=0;
        var zoom=0;//缩放大小
        var k=10;//放大倍数
        var mod=0;//显示模式，实时与历史
        var time_mode=0;//时间显示模式，0表示绝对时间，1表示相对时间


        var c=document.getElementById("myCanvas");//获得canvas

        c.width=window.screen.availWidth*0.85;

        width=c.getAttribute("width");
        height=c.getAttribute("height");


        init();


     

        function cancel_zoom() {//取消缩放
            zoom=0;
            data_time_change=data_time;
            hpv_change=hpv;
            tpv_change=tpv;
            change_left=0;
            change_right=hpv.length-1;

        }

        function update_all_data() {
            hpv_change = zoom_data(hpv,change_left,change_right);
            tpv_change = zoom_data(tpv,change_left,change_right);
            data_time_change=zoom_data(data_time,change_left,change_right);

        }


        function get_select_data(left,right) {
            var index_r=x_transform_back(hpv_change.length,right);
            var index_l=x_transform_back(hpv_change.length,left);
            if(index_r-index_l>9)
            {
                change_left+=index_l;
                change_right=change_left-index_l+index_r;
                console.log(change_left);
                console.log(change_right);
                hpv_change=hpv_change.slice(index_l,index_r);
                tpv_change=tpv_change.slice(index_l,index_r);
                data_time_change=data_time_change.slice(index_l,index_r);
            }
            else{
                if(date_time_mode.switch)
                {

                    alert(date_time_mode.switch+"所选区域小于十个点，请重新选择");
                }

            }



        }


        function absolute_time() {

            data_time=data_time_absolute;

        }

        function relative_time() {//获得相对时间
            var start_data=strto_date(data_time_absolute[0]);

            data_time_relative[0]="0:0:0";
            for(var i=1;i<data_time_absolute.length;i++)
            {
                data_time_relative[i]=count_time(start_data,strto_date(data_time_absolute[i]));
            }
            data_time=data_time_relative;


        }

        function time_select(start,end) {//获得通过日历选择的数据
            console.log(start);
            console.log(end);

            var start_index=0;
            var end_index=data_time_absolute.length-1;
            while(new Date(Date.parse(data_time_absolute[start_index].replace(/-/g,"/")))<start)
            {
                start_index++;
                if(start_index>data_time_absolute.length)
                {
                    break;
                }

            }
            while(new Date(Date.parse(data_time_absolute[end_index].replace(/-/g,"/")))>end)
            {
                end_index--;
                if(end_index<0)
                {
                    break;
                }

            }
            if(start_index<end_index)
            {
                data_time=data_time_absolute.slice(start_index,end_index);
                data_time_absolute=data_time_absolute.slice(start_index,end_index);
                tpv=tpv.slice(start_index,end_index);
                hpv=hpv.slice(start_index,end_index);
                console.log(data_time.length);
            }
            else{
                data_time_absolute.length=1;
                data_time.length=1;
                tpv.length=1;
                hpv.length=1;
                alert("数据不存在");
            }



        }//挑选时间

        $(document).ready(function(){
          $("#myCanvas").mouseenter(function(){
            document.getElementById("myCanvas1").style.display="inline";
            isin=1;
          });
          $("#myCanvas").mouseleave(function(){

              document.getElementById("myCanvas1").style.display="none";
            isin=0;
          });
          $('#myCanvas').on('mousewheel DOMMouseScroll', onMouseScroll);
        });

        $('#myCanvas').mousemove(function(e) {  //鼠标放在图像上时触发

             var positionX=e.pageX-$(this).offset().left; //获取当前鼠标相对img的X坐标
             var positionY=e.pageY-$(this).offset().top; //获取当前鼠标相对img的Y坐标
             mouse_x=positionX;
             mouse_y=positionY;
             isin=1;



            })


        function init() {//初始化函数
            noupdate();
            update();
            
        }
        function noupdate_y(ctx) {

            var nums=0;
            ctx.save()
            ctx.font = "bold 15px Arial";
            ctx.fillStyle="#2b85e4";
            for(i=50;i<height;i+=50)
            {
                drawLine(ctx,0,i,10,i,"#2b85e4",3);
                drawLine(ctx,0,i,width,i,"#5cadff",0.6);

                ctx.fillText(30-nums*k*2,5,i-5);
                nums++;
            }
            ctx.restore();


        }
        function get_day(data,index)//获得天
        {
            return data.slice(0,index);
        }
        function get_time(data,index) {//获得具体时间
            return data.slice(index+1,data.length);
        }
        function noupdate_x(ctx) {


             ctx.save()
            ctx.font = "bold 15px Arial";
            ctx.fillStyle="#2b85e4";

            for(var i=0;i<width;i+=150)
            {
                //alert(width);
                drawLine(ctx,i,height-10,i,height,"#2b85e4",3);
                drawLine(ctx,i,0,i,height,"#5cadff",0.6);

                data=data_time_change[parseInt(data_time_change.length*i/width)];

                if(data!=null)
                {

                    if(date_time_mode.display_time_mode)
                    {
                        ctx.fillText(data, i + 5, height-5);
                    }
                    else {

                        var index = data.indexOf(" ");
                        ctx.fillText(get_day(data, index), i + 5, height);
                        ctx.fillText(get_time(data, index), i + 5, height - 20);
                    }
                }

            }
            ctx.restore();

        }
        function noupdate() {//不需要更新的部分
            var c=document.getElementById("myCanvas");
            var ctx=c.getContext("2d");
            ctx.save();


            drawLine(ctx,0,height/2,width,height/2,"#888",2);
            drawLine(ctx,1,1,1,height,"#888",3);
            drawLine(ctx,width-75,25,width-35,25,"#f40",5);
            drawLine(ctx,width-75,50,width-35,50,"#f40",5);

            ctx.font = "bold 15px Arial";
            ctx.fillStyle="#f40";
            ctx.fillText("温度",width-30,30);
            ctx.fillStyle="#f40";
            ctx.fillText("湿度",width-30,55);


            noupdate_y(ctx);
            noupdate_x(ctx);

            ctx.restore();
        }
        function data_handel(dat)//数据初步处理,主要是放大作用
        {
            var da=height/2-k*dat;
            return da;
        }

        function zoom_data(data0,left,right) {

            var da=new Array();
            var k=0;
            for(var i=left;i<right;i++)
            {
                da[k]=data0[i];
                k++;
            }

            return da;

        }

        function update()//实时更新
        {

            var c = document.getElementById("myCanvas");
            var ctx = c.getContext("2d");
            get_image=c.toDataURL("image/png");
            ctx.clearRect(0, 0, width, height); //清空所有的内容

            noupdate();








            if(zoom==0){
                data_time_change=data_time;
                hpv_change=hpv;
                tpv_change=tpv;

                for(let key  in display_data_change){

                    display_data_change[key]=display_data[key];
              }

                change_left=0;
                change_right=display_data.data1.length-1;
            }
            else{//会增加消耗，但实时更新
                //hpv_change = zoom_data(hpv,change_left,change_right);
                //tpv_change = zoom_data(tpv,change_left,change_right);
                //data_time_change=zoom_data(data_time,change_left,change_right);
            }


            var sss=4;
            for(let key  in display_data_change){
                 //console.log(display_data[key])
                    draw_data_all(ctx,data_off(display_data_change[key]),"#"+sss+(sss+2)+(sss+3),1.5);
                    sss+=2;
              }

             if(isin==1)
                {

                    position_detect(ctx);

                }



            if(hpv_change.length>1)
            {
                if(tpv_hpv_control.switch1)
                {
                    draw_data_all(ctx,data_off(hpv_change),tpv_hpv_control.color_hpv,1.5);
                }
                if(tpv_hpv_control.switch2)
                {
                    draw_data_all(ctx,data_off(tpv_change),tpv_hpv_control.color_tpv,1.5);
                }

                 if(isin==1)
                {

                    position_detect(ctx);
                    //drawLine(ctx,mouse_x,1,mouse_x,height,"#0f4");
                    if(tpv_hpv_control.switch1||tpv_hpv_control.switch2)
                    {
                        position_detect(ctx);
                    }

                }
            }



            requestAnimationFrame(update);


        }


        Date.prototype.Format = function (fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //日
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //分
                "s+": this.getSeconds(), //秒
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[
                    k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        }


    </script>




</html>
